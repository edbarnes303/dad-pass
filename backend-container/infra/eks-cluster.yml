AWSTemplateFormatVersion: '2010-09-09'
Description: EKS Cluster with Fargate for dad-pass backend

Parameters:
    StageName:
        Type: String
        Default: dev
        AllowedValues:
            - dev
            - staging
            - prod
        Description: Deployment stage

    ClusterVersion:
        Type: String
        Default: '1.29'
        Description: Kubernetes version for EKS cluster

Resources:
    #############################################
    # EKS Cluster IAM Role
    #############################################
    EKSClusterRole:
        Type: AWS::IAM::Role
        Properties:
            RoleName: !Sub 'dad-pass-eks-cluster-role-${StageName}'
            AssumeRolePolicyDocument:
                Version: '2012-10-17'
                Statement:
                    - Effect: Allow
                      Principal:
                          Service: eks.amazonaws.com
                      Action: sts:AssumeRole
            ManagedPolicyArns:
                - arn:aws:iam::aws:policy/AmazonEKSClusterPolicy
            Tags:
                - Key: Project
                  Value: dad-pass
                - Key: Stage
                  Value: !Ref StageName

    #############################################
    # EKS Cluster
    #############################################
    EKSCluster:
        Type: AWS::EKS::Cluster
        Properties:
            Name: !Sub 'dad-pass-cluster-${StageName}'
            Version: !Ref ClusterVersion
            RoleArn: !GetAtt EKSClusterRole.Arn
            ResourcesVpcConfig:
                SubnetIds:
                    - '{{resolve:ssm:/private-subnet-1}}'
                    - '{{resolve:ssm:/private-subnet-2}}'
                    - '{{resolve:ssm:/private-subnet-3}}'
                    - '{{resolve:ssm:/public-subnet-1}}'
                    - '{{resolve:ssm:/public-subnet-2}}'
                    - '{{resolve:ssm:/public-subnet-3}}'
                EndpointPublicAccess: true
                EndpointPrivateAccess: true
            Tags:
                - Key: Project
                  Value: dad-pass
                - Key: Stage
                  Value: !Ref StageName

    #############################################
    # Fargate Pod Execution Role
    #############################################
    FargatePodExecutionRole:
        Type: AWS::IAM::Role
        Properties:
            RoleName: !Sub 'dad-pass-fargate-pod-role-${StageName}'
            AssumeRolePolicyDocument:
                Version: '2012-10-17'
                Statement:
                    - Effect: Allow
                      Principal:
                          Service: eks-fargate-pods.amazonaws.com
                      Action: sts:AssumeRole
            ManagedPolicyArns:
                - arn:aws:iam::aws:policy/AmazonEKSFargatePodExecutionRolePolicy
            Tags:
                - Key: Project
                  Value: dad-pass
                - Key: Stage
                  Value: !Ref StageName

    #############################################
    # Fargate Profile for dad-pass namespace
    #############################################
    FargateProfile:
        Type: AWS::EKS::FargateProfile
        DependsOn: EKSCluster
        Properties:
            FargateProfileName: !Sub 'dad-pass-fargate-profile-${StageName}'
            ClusterName: !Ref EKSCluster
            PodExecutionRoleArn: !GetAtt FargatePodExecutionRole.Arn
            Subnets:
                - '{{resolve:ssm:/private-subnet-1}}'
                - '{{resolve:ssm:/private-subnet-2}}'
                - '{{resolve:ssm:/private-subnet-3}}'
            Selectors:
                - Namespace: dad-pass
            Tags:
                - Key: Project
                  Value: dad-pass
                - Key: Stage
                  Value: !Ref StageName

    #############################################
    # Fargate Profile for kube-system (ALB Controller)
    #############################################
    FargateProfileKubeSystem:
        Type: AWS::EKS::FargateProfile
        DependsOn: EKSCluster
        Properties:
            FargateProfileName: !Sub 'dad-pass-fargate-kube-system-${StageName}'
            ClusterName: !Ref EKSCluster
            PodExecutionRoleArn: !GetAtt FargatePodExecutionRole.Arn
            Subnets:
                - '{{resolve:ssm:/private-subnet-1}}'
                - '{{resolve:ssm:/private-subnet-2}}'
                - '{{resolve:ssm:/private-subnet-3}}'
            Selectors:
                - Namespace: kube-system
            Tags:
                - Key: Project
                  Value: dad-pass
                - Key: Stage
                  Value: !Ref StageName

    #############################################
    # OIDC Provider for IRSA
    #############################################
    OIDCProvider:
        Type: AWS::IAM::OIDCProvider
        DependsOn: EKSCluster
        Properties:
            Url: !GetAtt EKSCluster.OpenIdConnectIssuerUrl
            ClientIdList:
                - sts.amazonaws.com
            ThumbprintList:
                - '9e99a48a9960b14926bb7f3b02e22da2b0ab7280'
            Tags:
                - Key: Project
                  Value: dad-pass
                - Key: Stage
                  Value: !Ref StageName

    #############################################
    # IAM Role for App Pods (IRSA)
    #############################################
    AppPodRole:
        Type: AWS::IAM::Role
        DependsOn: OIDCProviderHost
        Properties:
            RoleName: !Sub 'dad-pass-app-pod-role-${StageName}'
            AssumeRolePolicyDocument:
                Fn::Sub:
                    - |
                        {
                          "Version": "2012-10-17",
                          "Statement": [
                            {
                              "Effect": "Allow",
                              "Principal": {
                                "Federated": "arn:aws:iam::${AWS::AccountId}:oidc-provider/${OidcHost}"
                              },
                              "Action": "sts:AssumeRoleWithWebIdentity",
                              "Condition": {
                                "StringEquals": {
                                  "${OidcHost}:sub": "system:serviceaccount:dad-pass:dad-pass-sa",
                                  "${OidcHost}:aud": "sts.amazonaws.com"
                                }
                              }
                            }
                          ]
                        }
                    - OidcHost: !GetAtt OIDCProviderHost.Host
            Policies:
                - PolicyName: DadPassAppPolicy
                  PolicyDocument:
                      Version: '2012-10-17'
                      Statement:
                          # DynamoDB Access
                          - Effect: Allow
                            Action:
                                - dynamodb:GetItem
                                - dynamodb:PutItem
                                - dynamodb:DeleteItem
                                - dynamodb:Query
                                - dynamodb:Scan
                            Resource: !Sub 'arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/dad-pass-messages-${StageName}'
                          # SSM Parameter Store (encryption key)
                          - Effect: Allow
                            Action:
                                - ssm:GetParameter
                            Resource: !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/dad-pass/encryption-key'
            Tags:
                - Key: Project
                  Value: dad-pass
                - Key: Stage
                  Value: !Ref StageName

    #############################################
    # IAM Role for ALB Ingress Controller (IRSA)
    #############################################
    ALBControllerRole:
        Type: AWS::IAM::Role
        DependsOn: OIDCProviderHost
        Properties:
            RoleName: !Sub 'dad-pass-alb-controller-role-${StageName}'
            AssumeRolePolicyDocument:
                Fn::Sub:
                    - |
                        {
                          "Version": "2012-10-17",
                          "Statement": [
                            {
                              "Effect": "Allow",
                              "Principal": {
                                "Federated": "arn:aws:iam::${AWS::AccountId}:oidc-provider/${OidcHost}"
                              },
                              "Action": "sts:AssumeRoleWithWebIdentity",
                              "Condition": {
                                "StringEquals": {
                                  "${OidcHost}:sub": "system:serviceaccount:kube-system:aws-load-balancer-controller",
                                  "${OidcHost}:aud": "sts.amazonaws.com"
                                }
                              }
                            }
                          ]
                        }
                    - OidcHost: !GetAtt OIDCProviderHost.Host
            ManagedPolicyArns:
                - !Ref ALBControllerPolicy
            Tags:
                - Key: Project
                  Value: dad-pass
                - Key: Stage
                  Value: !Ref StageName

    #############################################
    # ALB Controller IAM Policy
    #############################################
    ALBControllerPolicy:
        Type: AWS::IAM::ManagedPolicy
        Properties:
            ManagedPolicyName: !Sub 'dad-pass-alb-controller-policy-${StageName}'
            PolicyDocument:
                Version: '2012-10-17'
                Statement:
                    - Effect: Allow
                      Action:
                          - iam:CreateServiceLinkedRole
                      Resource: '*'
                      Condition:
                          StringEquals:
                              iam:AWSServiceName: elasticloadbalancing.amazonaws.com
                    - Effect: Allow
                      Action:
                          - ec2:DescribeAccountAttributes
                          - ec2:DescribeAddresses
                          - ec2:DescribeAvailabilityZones
                          - ec2:DescribeInternetGateways
                          - ec2:DescribeVpcs
                          - ec2:DescribeVpcPeeringConnections
                          - ec2:DescribeSubnets
                          - ec2:DescribeSecurityGroups
                          - ec2:DescribeInstances
                          - ec2:DescribeNetworkInterfaces
                          - ec2:DescribeTags
                          - ec2:GetCoipPoolUsage
                          - ec2:DescribeCoipPools
                          - elasticloadbalancing:DescribeLoadBalancers
                          - elasticloadbalancing:DescribeLoadBalancerAttributes
                          - elasticloadbalancing:DescribeListeners
                          - elasticloadbalancing:DescribeListenerCertificates
                          - elasticloadbalancing:DescribeSSLPolicies
                          - elasticloadbalancing:DescribeRules
                          - elasticloadbalancing:DescribeTargetGroups
                          - elasticloadbalancing:DescribeTargetGroupAttributes
                          - elasticloadbalancing:DescribeTargetHealth
                          - elasticloadbalancing:DescribeTags
                          - elasticloadbalancing:DescribeTrustStores
                      Resource: '*'
                    - Effect: Allow
                      Action:
                          - cognito-idp:DescribeUserPoolClient
                          - acm:ListCertificates
                          - acm:DescribeCertificate
                          - iam:ListServerCertificates
                          - iam:GetServerCertificate
                          - waf-regional:GetWebACL
                          - waf-regional:GetWebACLForResource
                          - waf-regional:AssociateWebACL
                          - waf-regional:DisassociateWebACL
                          - wafv2:GetWebACL
                          - wafv2:GetWebACLForResource
                          - wafv2:AssociateWebACL
                          - wafv2:DisassociateWebACL
                          - shield:GetSubscriptionState
                          - shield:DescribeProtection
                          - shield:CreateProtection
                          - shield:DeleteProtection
                      Resource: '*'
                    - Effect: Allow
                      Action:
                          - ec2:AuthorizeSecurityGroupIngress
                          - ec2:RevokeSecurityGroupIngress
                      Resource: '*'
                    - Effect: Allow
                      Action:
                          - ec2:CreateSecurityGroup
                      Resource: '*'
                    - Effect: Allow
                      Action:
                          - ec2:CreateTags
                      Resource: 'arn:aws:ec2:*:*:security-group/*'
                      Condition:
                          StringEquals:
                              ec2:CreateAction: CreateSecurityGroup
                          'Null':
                              aws:RequestTag/elbv2.k8s.aws/cluster: 'false'
                    - Effect: Allow
                      Action:
                          - ec2:CreateTags
                          - ec2:DeleteTags
                      Resource: 'arn:aws:ec2:*:*:security-group/*'
                      Condition:
                          'Null':
                              aws:RequestTag/elbv2.k8s.aws/cluster: 'true'
                              aws:ResourceTag/elbv2.k8s.aws/cluster: 'false'
                    - Effect: Allow
                      Action:
                          - ec2:AuthorizeSecurityGroupIngress
                          - ec2:RevokeSecurityGroupIngress
                          - ec2:DeleteSecurityGroup
                      Resource: '*'
                      Condition:
                          'Null':
                              aws:ResourceTag/elbv2.k8s.aws/cluster: 'false'
                    - Effect: Allow
                      Action:
                          - elasticloadbalancing:CreateLoadBalancer
                          - elasticloadbalancing:CreateTargetGroup
                      Resource: '*'
                      Condition:
                          'Null':
                              aws:RequestTag/elbv2.k8s.aws/cluster: 'false'
                    - Effect: Allow
                      Action:
                          - elasticloadbalancing:AddTags
                          - elasticloadbalancing:RemoveTags
                      Resource:
                          - 'arn:aws:elasticloadbalancing:*:*:targetgroup/*/*'
                          - 'arn:aws:elasticloadbalancing:*:*:loadbalancer/net/*/*'
                          - 'arn:aws:elasticloadbalancing:*:*:loadbalancer/app/*/*'
                      Condition:
                          'Null':
                              aws:RequestTag/elbv2.k8s.aws/cluster: 'true'
                              aws:ResourceTag/elbv2.k8s.aws/cluster: 'false'
                    - Effect: Allow
                      Action:
                          - elasticloadbalancing:AddTags
                          - elasticloadbalancing:RemoveTags
                      Resource:
                          - 'arn:aws:elasticloadbalancing:*:*:listener/net/*/*/*'
                          - 'arn:aws:elasticloadbalancing:*:*:listener/app/*/*/*'
                          - 'arn:aws:elasticloadbalancing:*:*:listener-rule/net/*/*/*'
                          - 'arn:aws:elasticloadbalancing:*:*:listener-rule/app/*/*/*'
                    - Effect: Allow
                      Action:
                          - elasticloadbalancing:ModifyLoadBalancerAttributes
                          - elasticloadbalancing:SetIpAddressType
                          - elasticloadbalancing:SetSecurityGroups
                          - elasticloadbalancing:SetSubnets
                          - elasticloadbalancing:DeleteLoadBalancer
                          - elasticloadbalancing:ModifyTargetGroup
                          - elasticloadbalancing:ModifyTargetGroupAttributes
                          - elasticloadbalancing:DeleteTargetGroup
                      Resource: '*'
                      Condition:
                          'Null':
                              aws:ResourceTag/elbv2.k8s.aws/cluster: 'false'
                    - Effect: Allow
                      Action:
                          - elasticloadbalancing:AddTags
                      Resource:
                          - 'arn:aws:elasticloadbalancing:*:*:targetgroup/*/*'
                          - 'arn:aws:elasticloadbalancing:*:*:loadbalancer/net/*/*'
                          - 'arn:aws:elasticloadbalancing:*:*:loadbalancer/app/*/*'
                      Condition:
                          'Null':
                              aws:RequestTag/elbv2.k8s.aws/cluster: 'false'
                          StringEquals:
                              elasticloadbalancing:CreateAction:
                                  - CreateTargetGroup
                                  - CreateLoadBalancer
                    - Effect: Allow
                      Action:
                          - elasticloadbalancing:RegisterTargets
                          - elasticloadbalancing:DeregisterTargets
                      Resource: 'arn:aws:elasticloadbalancing:*:*:targetgroup/*/*'
                    - Effect: Allow
                      Action:
                          - elasticloadbalancing:SetWebAcl
                          - elasticloadbalancing:ModifyListener
                          - elasticloadbalancing:AddListenerCertificates
                          - elasticloadbalancing:RemoveListenerCertificates
                          - elasticloadbalancing:ModifyRule
                          - elasticloadbalancing:CreateListener
                          - elasticloadbalancing:DeleteListener
                          - elasticloadbalancing:CreateRule
                          - elasticloadbalancing:DeleteRule
                      Resource: '*'

    #############################################
    # Helper to extract OIDC host
    #############################################
    OIDCProviderHost:
        Type: AWS::CloudFormation::CustomResource
        DependsOn: EKSCluster
        Properties:
            ServiceToken: !GetAtt OIDCHostExtractor.Arn
            OIDCUrl: !GetAtt EKSCluster.OpenIdConnectIssuerUrl

    OIDCHostExtractorRole:
        Type: AWS::IAM::Role
        Properties:
            AssumeRolePolicyDocument:
                Version: '2012-10-17'
                Statement:
                    - Effect: Allow
                      Principal:
                          Service: lambda.amazonaws.com
                      Action: sts:AssumeRole
            ManagedPolicyArns:
                - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole

    OIDCHostExtractor:
        Type: AWS::Lambda::Function
        Properties:
            Runtime: python3.12
            Handler: index.handler
            Role: !GetAtt OIDCHostExtractorRole.Arn
            Timeout: 30
            Code:
                ZipFile: |
                    import cfnresponse
                    import urllib.parse
                    def handler(event, context):
                        try:
                            if event['RequestType'] == 'Delete':
                                cfnresponse.send(event, context, cfnresponse.SUCCESS, {})
                                return
                            oidc_url = event['ResourceProperties']['OIDCUrl']
                            # Extract host from URL (remove https://)
                            host = urllib.parse.urlparse(oidc_url).netloc + urllib.parse.urlparse(oidc_url).path
                            if host.startswith('https://'):
                                host = host[8:]
                            cfnresponse.send(event, context, cfnresponse.SUCCESS, {'Host': host}, host)
                        except Exception as e:
                            cfnresponse.send(event, context, cfnresponse.FAILED, {'Error': str(e)})

Outputs:
    ClusterName:
        Description: EKS Cluster Name
        Value: !Ref EKSCluster
        Export:
            Name: !Sub '${AWS::StackName}-ClusterName'

    ClusterArn:
        Description: EKS Cluster ARN
        Value: !GetAtt EKSCluster.Arn
        Export:
            Name: !Sub '${AWS::StackName}-ClusterArn'

    ClusterEndpoint:
        Description: EKS Cluster Endpoint
        Value: !GetAtt EKSCluster.Endpoint
        Export:
            Name: !Sub '${AWS::StackName}-ClusterEndpoint'

    OIDCIssuerUrl:
        Description: OIDC Provider URL
        Value: !GetAtt EKSCluster.OpenIdConnectIssuerUrl
        Export:
            Name: !Sub '${AWS::StackName}-OIDCIssuerUrl'

    OIDCProviderArn:
        Description: OIDC Provider ARN
        Value: !GetAtt OIDCProvider.Arn
        Export:
            Name: !Sub '${AWS::StackName}-OIDCProviderArn'

    AppPodRoleArn:
        Description: IAM Role ARN for app pods
        Value: !GetAtt AppPodRole.Arn
        Export:
            Name: !Sub '${AWS::StackName}-AppPodRoleArn'

    ALBControllerRoleArn:
        Description: IAM Role ARN for ALB Controller
        Value: !GetAtt ALBControllerRole.Arn
        Export:
            Name: !Sub '${AWS::StackName}-ALBControllerRoleArn'

    VpcId:
        Description: VPC ID used by the cluster
        Value: '{{resolve:ssm:/VpcId}}'
        Export:
            Name: !Sub '${AWS::StackName}-VpcId'
